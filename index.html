<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Receipt Manager">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
    <title>New Hasnain Car Showroom - Receipt Manager</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 600px; margin: 0 auto; }
        .login-container, .header, .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .login-container { padding: 30px; text-align: center; }
        .login-container h1 { color: #667eea; font-size: 24px; margin-bottom: 10px; }
        .header { 
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
        }
        .header h1 { color: #667eea; font-size: 24px; margin-bottom: 5px; }
        .header p { color: #666; font-size: 14px; }
        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 10px;
        }
        .notification-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #dc3545;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .card {
            padding: 20px;
            padding-bottom: 80px;
            margin-bottom: 20px;
            min-height: calc(100vh - 200px);
        }
        .tab-buttons {
            display: flex;
            gap: 5px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 10px;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            overflow-x: auto;
        }
        .tab-btn {
            flex: 0 1 auto;
            padding: 10px 5px;
            border: none;
            background: transparent;
            color: #999;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }
        .tab-btn.active { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .tab-icon { font-size: 18px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 15px; }
        label { 
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }
        input[type="text"], input[type="password"], input[type="date"], input[type="number"], select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }
        input[type="text"]:focus, input[type="password"]:focus, input[type="date"]:focus, input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 2px dashed #667eea;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
        }
        .radio-group { display: flex; gap: 20px; margin: 10px 0; }
        .radio-group label { display: flex; align-items: center; font-weight: normal; cursor: pointer; }
        .installment-section, .expense-section {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }
        .installment-section { display: none; }
        .expense-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
        .preview-image { width: 100%; max-height: 300px; object-fit: contain; border-radius: 10px; margin-top: 10px; border: 2px solid #e0e0e0; display: none; }
        .receipt-item { padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 10px; cursor: pointer; }
        .receipt-item:hover { border-color: #667eea; background: #f8f9ff; }
        .receipt-reg { font-size: 18px; font-weight: 700; color: #667eea; margin-bottom: 5px; }
        .receipt-date { font-size: 12px; color: #999; }
        .payment-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 5px;
        }
        .payment-badge.cash { background: #d4edda; color: #155724; }
        .payment-badge.installment { background: #fff3cd; color: #856404; }
        .payment-badge.pending { background: #f8d7da; color: #721c24; }
        .success-msg, .error-msg {
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
        }
        .success-msg { background: #d4edda; color: #155724; }
        .error-msg { background: #f8d7da; color: #721c24; }
        .alert-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
        }
        .alert-box.danger { background: #f8d7da; border-left-color: #dc3545; }
        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .stat-item { text-align: center; }
        .stat-number { font-size: 24px; font-weight: 700; color: #667eea; }
        .stat-label { font-size: 12px; color: #666; margin-top: 5px; }
        .profit-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
            margin-bottom: 20px;
            text-align: center;
        }
        .profit-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        .profit-value { font-weight: 700; }
        .commission-section {
            background: #d4edda;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid #28a745;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content {
            position: relative;
            max-width: 900px;
            width: 100%;
        }
        .modal-image { width: 100%; border-radius: 10px; }
        .close-modal {
            position: absolute;
            top: -40px;
            right: 0;
            background: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }
        .no-results { text-align: center; padding: 40px; color: #999; }
        .loading { text-align: center; padding: 20px; color: #667eea; font-weight: 600; }
        .hidden { display: none !important; }
        .date-range-input { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .export-card {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .export-card h4 { color: #667eea; font-size: 14px; margin: 0; }
        .export-card .btn {
            width: auto;
            padding: 8px 15px;
            font-size: 13px;
            margin: 0;
        }
        .btn-small { padding: 8px 12px; font-size: 12px; width: auto; }
        .delete-btn { background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; font-size: 12px; cursor: pointer; }
        .remove-expense-btn { background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 11px; cursor: pointer; margin-left: 10px; }
        @media (max-width: 480px) {
            body { padding: 10px; }
            .header h1 { font-size: 20px; }
            .card { padding: 15px; padding-bottom: 80px; }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="container">
        <div class="login-container">
            <h1>üöó NEW HASNAIN CAR SHOWROOM</h1>
            <p>Sale Receipt Digital Book</p>
            <p style="font-size: 11px; color: #999; margin-top: 8px;">Created by WM</p>
            
            <div style="margin-top: 30px;">
                <div class="error-msg" id="login-error"></div>
                <div class="form-group" style="text-align: left;">
                    <label>Password</label>
                    <input type="password" id="login-password" placeholder="Enter password">
                </div>
                <button class="btn btn-primary" onclick="login()">üîì Login</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="container hidden">
        <div class="header">
            <h1>üöó NEW HASNAIN CAR SHOWROOM</h1>
            <p>Sale Receipt Digital Book</p>
            <div class="notification-badge hidden" id="overdue-badge">
                <span id="overdue-count">0</span> Overdue
            </div>
            <button class="logout-btn" onclick="logout()">üö™ Logout</button>
        </div>

        <div class="card">
            <!-- Upload Tab -->
            <div id="upload-tab" class="tab-content active">
                <div class="success-msg" id="upload-success"></div>
                <div class="error-msg" id="upload-error"></div>
                
                <div class="form-group">
                    <label>Car Name/Model *</label>
                    <input type="text" id="car-name" placeholder="e.g., Toyota Corolla 2020">
                </div>
                
                <div class="form-group">
                    <label>Car Registration Number *</label>
                    <input type="text" id="reg-number" placeholder="e.g., ABC-123" style="text-transform: uppercase;">
                </div>

                <div class="form-group">
                    <label>Customer Name *</label>
                    <input type="text" id="customer-name" placeholder="e.g., Ahmed Khan">
                </div>

                <div class="form-group">
                    <label>Customer Phone *</label>
                    <input type="text" id="customer-phone" placeholder="e.g., 03001234567">
                </div>
                
                <div class="form-group">
                    <label>Selling Date *</label>
                    <input type="date" id="selling-date">
                </div>
                
                <div class="form-group">
                    <label>Selling Price (PKR) *</label>
                    <input type="number" id="selling-price" placeholder="e.g., 2500000" min="0" step="1000">
                </div>

                <div class="form-group">
                    <label>Purchase Cost (PKR) *</label>
                    <input type="number" id="purchase-cost" placeholder="e.g., 2000000" min="0" step="1000">
                </div>

                <div class="form-group">
                    <label>Payment Type *</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="payment-type" value="CASH" checked onchange="toggleInstallmentSection()">
                            üíµ Cash
                        </label>
                        <label>
                            <input type="radio" name="payment-type" value="INSTALLMENT" onchange="toggleInstallmentSection()">
                            üìÖ Installment
                        </label>
                    </div>
                </div>

                <div class="installment-section" id="installment-section">
                    <div class="form-group">
                        <label>Down Payment (PKR) *</label>
                        <input type="number" id="down-payment" placeholder="e.g., 500000" min="0" step="1000">
                    </div>

                    <div class="form-group">
                        <label>Number of Installments *</label>
                        <select id="installment-count" onchange="generateInstallmentFields()">
                            <option value="1">1 Installment</option>
                            <option value="2">2 Installments</option>
                            <option value="3">3 Installments</option>
                            <option value="4">4 Installments</option>
                            <option value="5">5 Installments</option>
                            <option value="6">6 Installments</option>
                        </select>
                    </div>

                    <div id="installment-fields"></div>
                </div>

                <!-- Expenses Section -->
                <div class="expense-section">
                    <h4 style="color: #667eea; margin-bottom: 10px;">üí∏ Additional Expenses (Optional)</h4>
                    <div id="expenses-container"></div>
                    <button type="button" class="btn btn-primary" onclick="addExpenseField()" style="margin-top: 10px; padding: 8px; font-size: 14px;">
                        ‚ûï Add Expense
                    </button>
                </div>

                <div class="form-group">
                    <label>Sold By (Employee) *</label>
                    <select id="sold-by">
                        <option value="">Select Employee</option>
                        <option value="Ali">Ali</option>
                        <option value="Hassan">Hassan</option>
                        <option value="Usman">Usman</option>
                        <option value="Bilal">Bilal</option>
                        <option value="Kamran">Kamran</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Receipt Photo *</label>
                    <input type="file" id="receipt-photo" accept="image/*">
                </div>
                
                <img id="preview" class="preview-image">
                
                <button class="btn btn-primary" onclick="uploadReceipt()">üíæ Save Receipt</button>
            </div>

            <!-- Payments Tab -->
            <div id="payments-tab" class="tab-content">
                <h3 style="color: #667eea; margin-bottom: 20px;">üí∞ Payment Tracking</h3>

                <div class="alert-box danger" id="overdue-alert">
                    <strong>‚ö†Ô∏è Overdue Payments!</strong>
                    <div id="overdue-list" style="margin-top: 10px;"></div>
                </div>

                <div class="alert-box" id="upcoming-alert">
                    <strong>üìÖ Upcoming Payments</strong>
                    <div id="upcoming-list" style="margin-top: 10px;"></div>
                </div>

                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number" id="total-pending">‚Ç®0</div>
                        <div class="stat-label">Total Pending</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="total-received">‚Ç®0</div>
                        <div class="stat-label">Total Received</div>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="loadPayments()" style="margin-bottom: 15px;">üîÑ Refresh</button>

                <div id="payments-list"></div>
            </div>

            <!-- Search Tab -->
            <div id="search-tab" class="tab-content">
                <div class="form-group">
                    <label>Search by Registration Number</label>
                    <input type="text" id="search-input" placeholder="e.g., ABC-123" style="text-transform: uppercase;">
                </div>
                <div class="form-group">
                    <label>Filter by Employee</label>
                    <select id="search-employee">
                        <option value="">All Employees</option>
                        <option value="Ali">Ali</option>
                        <option value="Hassan">Hassan</option>
                        <option value="Usman">Usman</option>
                        <option value="Bilal">Bilal</option>
                        <option value="Kamran">Kamran</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="performSearch()">üîç Search</button>
                <div id="search-results"></div>
            </div>

            <!-- All Receipts Tab -->
            <div id="all-tab" class="tab-content">
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number" id="total-receipts">0</div>
                        <div class="stat-label">Total Receipts</div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="loadAllReceipts()" style="margin-bottom: 15px;">üîÑ Refresh</button>
                <div id="all-receipts"></div>
            </div>

            <!-- Profit/Loss Tab -->
            <div id="profit-tab" class="tab-content">
                <h3 style="color: #667eea; margin-bottom: 20px; text-align: center;">üíµ Profit & Loss</h3>

                <div class="profit-card">
                    <h4 style="margin-bottom: 15px;">üìä Summary</h4>
                    <div class="profit-row">
                        <span>Total Revenue:</span>
                        <span class="profit-value" id="profit-total-revenue">‚Ç®0</span>
                    </div>
                    <div class="profit-row">
                        <span>Total Purchase Cost:</span>
                        <span class="profit-value" id="profit-total-cost">‚Ç®0</span>
                    </div>
                    <div class="profit-row">
                        <span>Total Expenses:</span>
                        <span class="profit-value" id="profit-total-expenses">‚Ç®0</span>
                    </div>
                    <div class="profit-row" style="border-bottom: 2px solid rgba(255,255,255,0.5); padding-top: 15px;">
                        <span style="font-weight: 700; font-size: 16px;">Net Profit:</span>
                        <span class="profit-value" style="font-size: 18px;" id="profit-net-profit">‚Ç®0</span>
                    </div>
                    <div class="profit-row" style="padding-top: 10px;">
                        <span>Profit Margin:</span>
                        <span class="profit-value" id="profit-margin">0%</span>
                    </div>
                </div>

                <h4 style="color: #667eea; margin-bottom: 15px;">üöó Profit Breakdown by Car</h4>
                <div id="profit-breakdown"></div>

                <button class="btn btn-primary" onclick="displayProfitAnalytics()" style="margin-bottom: 15px;">üîÑ Refresh</button>
            </div>

            <!-- Export Tab -->
            <div id="export-tab" class="tab-content">
                <h3 style="color: #667eea; margin-bottom: 20px;">üì• Export Reports</h3>

                <div class="form-group">
                    <label>Date Range (Optional)</label>
                    <div class="date-range-input">
                        <div>
                            <label style="font-size: 12px;">From Date</label>
                            <input type="date" id="export-from-date">
                        </div>
                        <div>
                            <label style="font-size: 12px;">To Date</label>
                            <input type="date" id="export-to-date">
                        </div>
                    </div>
                </div>

                <div id="export-buttons">
                    <div class="export-card">
                        <h4>üìã Sales Report</h4>
                        <button class="btn btn-primary btn-small" onclick="exportSalesReport()">Download</button>
                    </div>
                    <div class="export-card">
                        <h4>üí∞ Payment Tracking</h4>
                        <button class="btn btn-primary btn-small" onclick="exportPaymentReport()">Download</button>
                    </div>
                    <div class="export-card">
                        <h4>üíµ Profit & Loss</h4>
                        <button class="btn btn-primary btn-small" onclick="exportProfitReport()">Download</button>
                    </div>
                    <div class="export-card">
                        <h4>üí∏ Expense Report</h4>
                        <button class="btn btn-primary btn-small" onclick="exportExpenseReport()">Download</button>
                    </div>
                    <div class="export-card">
                        <h4>üèÜ Employee Performance</h4>
                        <button class="btn btn-primary btn-small" onclick="exportEmployeeReport()">Download</button>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="exportAllReports()" style="margin-top: 20px;">üì¶ Download All Reports (ZIP)</button>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics-tab" class="tab-content">
                <h3 style="color: #667eea; margin-bottom: 20px; text-align: center;">üìä Sales Analytics</h3>

                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; color: white; text-align: center;">
                        <div style="font-size: 28px; font-weight: 700;" id="total-cars">0</div>
                        <div style="font-size: 12px; margin-top: 5px;">Total Cars Sold</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 20px; border-radius: 10px; color: white; text-align: center;">
                        <div style="font-size: 28px; font-weight: 700;" id="total-revenue">‚Ç®0</div>
                        <div style="font-size: 12px; margin-top: 5px;">Total Revenue</div>
                    </div>
                </div>

                <div style="background: #f8f9ff; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: #667eea; margin-bottom: 15px;">üèÜ Top Salespeople</h4>
                    <div id="top-salespeople-list"></div>
                </div>

                <div style="background: #f8f9ff; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: #667eea; margin-bottom: 15px;">üöó Best Selling Cars</h4>
                    <div id="best-selling-list"></div>
                </div>

                <div style="background: #f8f9ff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: #667eea; margin-bottom: 15px;">üìÖ This Week</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <div style="font-size: 12px; color: #666;">Cars Sold</div>
                            <div style="font-size: 24px; font-weight: 700; color: #667eea;" id="week-cars">0</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #666;">Revenue</div>
                            <div style="font-size: 24px; font-weight: 700; color: #11998e;" id="week-revenue">‚Ç®0</div>
                        </div>
                    </div>
                </div>

                <div style="background: #f8f9ff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: #667eea; margin-bottom: 15px;">üìÜ This Month</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <div style="font-size: 12px; color: #666;">Cars Sold</div>
                            <div style="font-size: 24px; font-weight: 700; color: #667eea;" id="month-cars">0</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #666;">Revenue</div>
                            <div style="font-size: 24px; font-weight: 700; color: #11998e;" id="month-revenue">‚Ç®0</div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="calculateAnalytics()" style="margin-bottom: 15px;">üîÑ Refresh Analytics</button>
            </div>

            <!-- Bottom Navigation -->
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('upload')">
                    <span class="tab-icon">üì§</span>
                    <span>Upload</span>
                </button>
                <button class="tab-btn" onclick="switchTab('payments')">
                    <span class="tab-icon">üí∞</span>
                    <span>Payments</span>
                </button>
                <button class="tab-btn" onclick="switchTab('search')">
                    <span class="tab-icon">üîç</span>
                    <span>Search</span>
                </button>
                <button class="tab-btn" onclick="switchTab('all')">
                    <span class="tab-icon">üìã</span>
                    <span>All</span>
                </button>
                <button class="tab-btn" onclick="switchTab('profit')">
                    <span class="tab-icon">üíµ</span>
                    <span>Profit</span>
                </button>
                <button class="tab-btn" onclick="switchTab('export')">
                    <span class="tab-icon">üì•</span>
                    <span>Export</span>
                </button>
                <button class="tab-btn" onclick="switchTab('analytics')">
                    <span class="tab-icon">üìä</span>
                    <span>Stats</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for viewing receipt -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()">‚úï Close</button>
            <img id="modal-image" class="modal-image">
            <div style="text-align: center; margin-top: 15px;">
                <div style="color: white; font-size: 20px; font-weight: 700;" id="modal-reg"></div>
                <div style="color: white; font-size: 14px; margin-top: 5px;" id="modal-details"></div>
                <div id="modal-profit" style="margin-top: 15px;"></div>
                <div id="modal-installments" style="margin-top: 15px;"></div>
                <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="openDriveLink()" style="width: auto; padding: 10px 20px;">üìÅ View in Drive</button>
                    <button class="delete-btn" onclick="deleteReceipt()">üóëÔ∏è Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            PASSWORD: 'hasnain123',
            GOOGLE_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwSpSrETZ_ygPH8QRX9JhWghofmxlkNf3DCh-f6xTxVhEhTF_EQm6u0PBwKrhjimcaTlQ/exec',
            COMMISSION_RATE: 0
        };

        let currentViewingReceipt = null;
        let allReceiptsCache = [];
        let allInstallmentsCache = [];
        let allExpensesCache = [];
        let expenseCounter = 0;

        document.addEventListener('DOMContentLoaded', function() {
            checkLogin();
            
            document.getElementById('receipt-photo').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('preview').src = e.target.result;
                        document.getElementById('preview').style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });

            document.getElementById('login-password').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') login();
            });

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('selling-date').value = today;
            document.getElementById('export-to-date').value = today;
            
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            document.getElementById('export-from-date').value = oneYearAgo.toISOString().split('T')[0];
        });

        function checkLogin() {
            const isLoggedIn = sessionStorage.getItem('loggedIn');
            if (isLoggedIn === 'true') {
                showMainApp();
            } else {
                showLoginScreen();
            }
        }

        function login() {
            const password = document.getElementById('login-password').value;
            const errorMsg = document.getElementById('login-error');
            
            if (password === CONFIG.PASSWORD) {
                sessionStorage.setItem('loggedIn', 'true');
                showMainApp();
            } else {
                errorMsg.textContent = '‚ùå Incorrect password';
                errorMsg.style.display = 'block';
            }
        }

        function logout() {
            sessionStorage.removeItem('loggedIn');
            showLoginScreen();
        }

        function showLoginScreen() {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            loadAllReceipts();
            loadPayments();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.tab-btn').classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab + '-tab').classList.add('active');

            if (tab === 'all') {
                loadAllReceipts();
            } else if (tab === 'analytics') {
                calculateAnalytics();
            } else if (tab === 'payments') {
                loadPayments();
            } else if (tab === 'profit') {
                displayProfitAnalytics();
            }
        }

        function toggleInstallmentSection() {
            const paymentType = document.querySelector('input[name="payment-type"]:checked').value;
            const installmentSection = document.getElementById('installment-section');
            
            if (paymentType === 'INSTALLMENT') {
                installmentSection.style.display = 'block';
                generateInstallmentFields();
            } else {
                installmentSection.style.display = 'none';
            }
        }

        function generateInstallmentFields() {
            const count = parseInt(document.getElementById('installment-count').value);
            const container = document.getElementById('installment-fields');
            
            let html = '<h4 style="color: #667eea; margin: 15px 0 10px 0;">Installment Details:</h4>';
            
            for (let i = 1; i <= count; i++) {
                html += `
                    <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #667eea;">
                        <strong>Installment ${i}</strong>
                        <div class="form-group">
                            <label>Due Date</label>
                            <input type="date" id="inst-date-${i}" required>
                        </div>
                        <div class="form-group">
                            <label>Amount (PKR)</label>
                            <input type="number" id="inst-amount-${i}" placeholder="Amount" min="0" step="1000" required>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function addExpenseField() {
            expenseCounter++;
            const container = document.getElementById('expenses-container');
            const expenseId = 'expense-' + expenseCounter;
            
            const expenseHTML = `
                <div class="expense-item" id="${expenseId}">
                    <div style="flex: 1;">
                        <select class="expense-type-select" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 5px; font-size: 13px; margin-bottom: 8px;">
                            <option value="">Type</option>
                            <option value="Repair">üîß Repair</option>
                            <option value="Maintenance">üõ†Ô∏è Maintenance</option>
                            <option value="Other">üìù Other</option>
                        </select>
                        <input type="text" class="expense-desc-input" placeholder="Description" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 5px; font-size: 13px; margin-bottom: 8px;">
                        <input type="number" class="expense-amount-input" placeholder="Amount (PKR)" min="0" step="100" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 5px; font-size: 13px;">
                    </div>
                    <button type="button" class="remove-expense-btn" onclick="removeExpenseField('${expenseId}')">‚úï</button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', expenseHTML);
        }

        function removeExpenseField(expenseId) {
            document.getElementById(expenseId).remove();
        }

        function getExpensesFromForm() {
            const expenses = [];
            const expenseItems = document.getElementById('expenses-container').children;
            
            for (let item of expenseItems) {
                const typeSelect = item.querySelector('.expense-type-select');
                const descInput = item.querySelector('.expense-desc-input');
                const amountInput = item.querySelector('.expense-amount-input');
                
                if (typeSelect && typeSelect.value && amountInput && parseFloat(amountInput.value) > 0) {
                    expenses.push({
                        type: typeSelect.value,
                        description: descInput ? descInput.value : '',
                        amount: parseFloat(amountInput.value)
                    });
                }
            }
            
            return expenses;
        }

        async function uploadReceipt() {
            const carName = document.getElementById('car-name').value.trim();
            const regNumber = document.getElementById('reg-number').value.trim().toUpperCase();
            const customerName = document.getElementById('customer-name').value.trim();
            const customerPhone = document.getElementById('customer-phone').value.trim();
            const sellingDate = document.getElementById('selling-date').value;
            const sellingPrice = document.getElementById('selling-price').value.trim();
            const purchaseCost = document.getElementById('purchase-cost').value.trim();
            const paymentType = document.querySelector('input[name="payment-type"]:checked').value;
            const soldBy = document.getElementById('sold-by').value;
            const photoInput = document.getElementById('receipt-photo');
            const photoFile = photoInput.files[0];
            
            const successMsg = document.getElementById('upload-success');
            const errorMsg = document.getElementById('upload-error');
            
            successMsg.style.display = 'none';
            errorMsg.style.display = 'none';

            // Validation
            if (!carName || !regNumber || !customerName || !customerPhone || !sellingDate || !sellingPrice || !purchaseCost || !soldBy || !photoFile) {
                errorMsg.textContent = 'Please fill all required fields';
                errorMsg.style.display = 'block';
                return;
            }

            if (parseFloat(sellingPrice) <= 0 || parseFloat(purchaseCost) <= 0) {
                errorMsg.textContent = 'Please enter valid prices';
                errorMsg.style.display = 'block';
                return;
            }

            let downPayment = 0;
            let installments = [];

            if (paymentType === 'INSTALLMENT') {
                downPayment = parseFloat(document.getElementById('down-payment').value) || 0;
                
                if (downPayment <= 0) {
                    errorMsg.textContent = 'Please enter down payment';
                    errorMsg.style.display = 'block';
                    return;
                }

                const count = parseInt(document.getElementById('installment-count').value);
                
                for (let i = 1; i <= count; i++) {
                    const date = document.getElementById(`inst-date-${i}`).value;
                    const amount = parseFloat(document.getElementById(`inst-amount-${i}`).value) || 0;
                    
                    if (!date || amount <= 0) {
                        errorMsg.textContent = `Please fill installment ${i}`;
                        errorMsg.style.display = 'block';
                        return;
                    }
                    
                    installments.push({ dueDate: date, amount: amount });
                }
            }

            const uploadBtn = event.target;
            const originalText = uploadBtn.textContent;
            uploadBtn.textContent = '‚è≥ Uploading...';
            uploadBtn.disabled = true;

            try {
                const imageData = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = () => reject(new Error('Failed to read image'));
                    reader.readAsDataURL(photoFile);
                });

                const receiptId = regNumber + '_' + sellingDate + '_' + Date.now();
                const fileName = receiptId + '.' + photoFile.name.split('.').pop();
                
                const expenses = getExpensesFromForm();
                const totalExpenses = expenses.reduce((sum, exp) => sum + exp.amount, 0);

                const receiptData = {
                    action: 'upload',
                    receiptId: receiptId,
                    carName: carName,
                    regNumber: regNumber,
                    customerName: customerName,
                    customerPhone: customerPhone,
                    sellingDate: sellingDate,
                    sellingPrice: parseFloat(sellingPrice),
                    purchaseCost: parseFloat(purchaseCost),
                    paymentType: paymentType,
                    downPayment: downPayment,
                    soldBy: soldBy,
                    installments: installments,
                    expenses: expenses,
                    totalExpenses: totalExpenses,
                    imageData: imageData,
                    fileName: fileName,
                    mimeType: photoFile.type,
                    timestamp: new Date().toISOString()
                };

                const response = await fetch(CONFIG.GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(receiptData)
                });

                const result = await response.json();
                
                if (result.success) {
                    successMsg.textContent = `‚úì Receipt saved for ${carName} (${regNumber})`;
                    successMsg.style.display = 'block';
                    
                    // Clear form
                    document.getElementById('car-name').value = '';
                    document.getElementById('reg-number').value = '';
                    document.getElementById('customer-name').value = '';
                    document.getElementById('customer-phone').value = '';
                    document.getElementById('selling-price').value = '';
                    document.getElementById('purchase-cost').value = '';
                    document.getElementById('sold-by').value = '';
                    photoInput.value = '';
                    document.getElementById('preview').style.display = 'none';
                    document.querySelector('input[name="payment-type"][value="CASH"]').checked = true;
                    document.getElementById('expenses-container').innerHTML = '';
                    expenseCounter = 0;
                    toggleInstallmentSection();
                    
                    window.scrollTo(0, 0);
                } else {
                    throw new Error(result.error || 'Upload failed');
                }
                
            } catch (error) {
                console.error('Error:', error);
                errorMsg.textContent = '‚úó Error: ' + error.message;
                errorMsg.style.display = 'block';
            } finally {
                uploadBtn.textContent = originalText;
                uploadBtn.disabled = false;
            }
        }

        async function loadAllReceipts() {
            const allReceiptsDiv = document.getElementById('all-receipts');
            const totalDiv = document.getElementById('total-receipts');
            
            allReceiptsDiv.innerHTML = '<div class="loading">Loading receipts...</div>';

            try {
                const response = await fetch(CONFIG.GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getAll' })
                });

                const result = await response.json();
                
                if (result.success) {
                    allReceiptsCache = result.receipts || [];
                    allInstallmentsCache = result.installments || [];
                    allExpensesCache = result.expenses || [];
                    
                    if (allReceiptsCache.length > 0) {
                        totalDiv.textContent = allReceiptsCache.length;
                        allReceiptsCache.sort((a, b) => new Date(b.sellingDate) - new Date(a.sellingDate));
                        
                        let html = '';
                        allReceiptsCache.forEach(receipt => {
                            const sellingDate = new Date(receipt.sellingDate).toLocaleDateString();
                            const price = `‚Ç®${parseFloat(receipt.sellingPrice).toLocaleString()}`;
                            
                            html += `
                                <div class="receipt-item" onclick='viewReceiptByData(${JSON.stringify(receipt).replace(/'/g, "&#39;")})'>
                                    <div class="receipt-reg">${receipt.carName || 'N/A'}</div>
                                    <div class="receipt-date">Reg: ${receipt.regNumber}</div>
                                    <div class="receipt-date">Customer: ${receipt.customerName || 'N/A'}</div>
                                    <div class="receipt-date">Date: ${sellingDate} ‚Ä¢ Price: ${price}</div>
                                    <div class="receipt-date">Sold by: ${receipt.soldBy || 'N/A'}</div>
                                </div>
                            `;
                        });
                        
                        allReceiptsDiv.innerHTML = html;
                    } else {
                        totalDiv.textContent = '0';
                        allReceiptsDiv.innerHTML = '<div class="no-results">No receipts uploaded yet.</div>';
                    }
                } else {
                    throw new Error(result.error || 'Failed to load');
                }
            } catch (error) {
                console.error('Error:', error);
                allReceiptsDiv.innerHTML = '<div class="no-results">Error loading receipts.</div>';
            }
        }

        async function loadPayments() {
            try {
                const response = await fetch(CONFIG.GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getAll' })
                });

                const result = await response.json();
                
                if (result.success) {
                    allReceiptsCache = result.receipts || [];
                    allInstallmentsCache = result.installments || [];
                    allExpensesCache = result.expenses || [];
                    
                    displayPaymentSummary();
                    checkOverduePayments();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function displayPaymentSummary() {
            const installmentReceipts = allReceiptsCache.filter(r => r.paymentType === 'INSTALLMENT');
            
            let totalPending = 0;
            let totalReceived = 0;
            let paymentsList = '';

            installmentReceipts.forEach(receipt => {
                const receiptInsts = allInstallmentsCache.filter(i => i.receiptId === receipt.receiptId);
                const pending = receiptInsts.filter(i => i.status === 'PENDING');
                const paid = receiptInsts.filter(i => i.status === 'PAID');
                
                totalPending += pending.reduce((sum, i) => sum + parseFloat(i.amount), 0);
                totalReceived += parseFloat(receipt.downPayment || 0) + paid.reduce((sum, i) => sum + parseFloat(i.amount), 0);
                
                if (pending.length > 0) {
                    paymentsList += `
                        <div class="receipt-item" onclick='viewReceiptByData(${JSON.stringify(receipt).replace(/'/g, "&#39;")})'>
                            <div class="receipt-reg">${receipt.carName} (${receipt.regNumber})</div>
                            <div class="receipt-date">Customer: ${receipt.customerName}</div>
                            <div class="receipt-date">Pending: ‚Ç®${pending.reduce((s, i) => s + parseFloat(i.amount), 0).toLocaleString()}</div>
                        </div>
                    `;
                }
            });

            document.getElementById('total-pending').textContent = `‚Ç®${totalPending.toLocaleString()}`;
            document.getElementById('total-received').textContent = `‚Ç®${totalReceived.toLocaleString()}`;
            
            const paymentsListDiv = document.getElementById('payments-list');
            if (paymentsList) {
                paymentsListDiv.innerHTML = paymentsList;
            } else {
                paymentsListDiv.innerHTML = '<div class="no-results">No pending payments</div>';
            }
        }

        function checkOverduePayments() {
            const today = new Date();
            const overdue = allInstallmentsCache.filter(i => 
                i.status === 'PENDING' && new Date(i.dueDate) < today
            );
            
            if (overdue.length > 0) {
                document.getElementById('overdue-badge').classList.remove('hidden');
                document.getElementById('overdue-count').textContent = overdue.length;
            } else {
                document.getElementById('overdue-badge').classList.add('hidden');
            }
        }

        async function performSearch() {
            const searchInput = document.getElementById('search-input').value.trim().toUpperCase();
            const searchEmployee = document.getElementById('search-employee').value;
            const resultsDiv = document.getElementById('search-results');
            
            resultsDiv.innerHTML = '<div class="loading">Searching...</div>';

            try {
                if (allReceiptsCache.length === 0) {
                    await loadAllReceipts();
                }

                let filtered = allReceiptsCache;
                
                if (searchInput) {
                    filtered = filtered.filter(r => r.regNumber === searchInput);
                }
                
                if (searchEmployee) {
                    filtered = filtered.filter(r => r.soldBy === searchEmployee);
                }
                
                if (filtered.length > 0) {
                    let html = '';
                    filtered.forEach(receipt => {
                        const date = new Date(receipt.sellingDate).toLocaleDateString();
                        const price = `‚Ç®${parseFloat(receipt.sellingPrice).toLocaleString()}`;
                        
                        html += `
                            <div class="receipt-item" onclick='viewReceiptByData(${JSON.stringify(receipt).replace(/'/g, "&#39;")})'>
                                <div class="receipt-reg">${receipt.carName || 'N/A'}</div>
                                <div class="receipt-date">Reg: ${receipt.regNumber}</div>
                                <div class="receipt-date">Customer: ${receipt.customerName || 'N/A'}</div>
                                <div class="receipt-date">Date: ${date} ‚Ä¢ Price: ${price}</div>
                                <div class="receipt-date">Sold by: ${receipt.soldBy || 'N/A'}</div>
                            </div>
                        `;
                    });
                    
                    resultsDiv.innerHTML = html;
                } else {
                    resultsDiv.innerHTML = '<div class="no-results">‚ùå No receipt found</div>';
                }
            } catch (error) {
                console.error('Search error:', error);
                resultsDiv.innerHTML = '<div class="no-results">‚ùå Error searching</div>';
            }
        }

        function calculateProfit(receipt) {
            const sellingPrice = parseFloat(receipt?.sellingPrice || 0);
            const purchaseCost = parseFloat(receipt?.purchaseCost || 0);
            
            const receiptExpenses = receipt ? 
                allExpensesCache.filter(e => e.receiptId === receipt.receiptId) : 
                [];
            const totalExpenses = receiptExpenses.reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
            
            const grossProfit = sellingPrice - purchaseCost;
            const netProfit = grossProfit - totalExpenses;
            const profitMargin = sellingPrice > 0 ? (netProfit / sellingPrice * 100) : 0;
            const commission = netProfit * CONFIG.COMMISSION_RATE;
            
            return {
                grossProfit: grossProfit,
                netProfit: netProfit,
                profitMargin: profitMargin,
                commission: commission,
                totalExpenses: totalExpenses
            };
        }

        function displayProfitAnalytics() {
            if (allReceiptsCache.length === 0) {
                document.getElementById('profit-breakdown').innerHTML = '<div class="no-results">No data available</div>';
                return;
            }

            let totalRevenue = 0;
            let totalCost = 0;
            let totalExpenses = 0;
            let totalProfit = 0;
            let totalCommission = 0;

            allReceiptsCache.forEach(receipt => {
                const profit = calculateProfit(receipt);
                totalRevenue += parseFloat(receipt.sellingPrice) || 0;
                totalCost += parseFloat(receipt.purchaseCost) || 0;
                totalExpenses += profit.totalExpenses;
                totalProfit += profit.netProfit;
                totalCommission += profit.commission;
            });

            document.getElementById('profit-total-revenue').textContent = `‚Ç®${totalRevenue.toLocaleString()}`;
            document.getElementById('profit-total-cost').textContent = `‚Ç®${totalCost.toLocaleString()}`;
            document.getElementById('profit-total-expenses').textContent = `‚Ç®${totalExpenses.toLocaleString()}`;
            document.getElementById('profit-net-profit').textContent = `‚Ç®${totalProfit.toLocaleString()}`;
            document.getElementById('profit-margin').textContent = totalRevenue > 0 ? ((totalProfit / totalRevenue) * 100).toFixed(2) + '%' : '0%';

            const carProfits = {};
            allReceiptsCache.forEach(receipt => {
                if (!carProfits[receipt.carName]) {
                    carProfits[receipt.carName] = {
                        count: 0,
                        totalRevenue: 0,
                        totalCost: 0,
                        totalExpenses: 0,
                        totalProfit: 0
                    };
                }
                
                const profit = calculateProfit(receipt);
                carProfits[receipt.carName].count += 1;
                carProfits[receipt.carName].totalRevenue += parseFloat(receipt.sellingPrice) || 0;
                carProfits[receipt.carName].totalCost += parseFloat(receipt.purchaseCost) || 0;
                carProfits[receipt.carName].totalExpenses += profit.totalExpenses;
                carProfits[receipt.carName].totalProfit += profit.netProfit;
            });

            let breakdownHTML = '';
            Object.entries(carProfits).forEach(([carName, data]) => {
                const margin = data.totalRevenue > 0 ? ((data.totalProfit / data.totalRevenue) * 100).toFixed(2) : 0;
                breakdownHTML += `
                    <div class="receipt-item">
                        <div class="receipt-reg">üöó ${carName}</div>
                        <div class="receipt-date">Sold: ${data.count} ‚Ä¢ Revenue: ‚Ç®${data.totalRevenue.toLocaleString()}</div>
                        <div class="receipt-date">Cost: ‚Ç®${data.totalCost.toLocaleString()} ‚Ä¢ Expenses: ‚Ç®${data.totalExpenses.toLocaleString()}</div>
                        <div style="color: #28a745; font-weight: 700; margin-top: 5px;">Profit: ‚Ç®${data.totalProfit.toLocaleString()} (${margin}%)</div>
                    </div>
                `;
            });

            document.getElementById('profit-breakdown').innerHTML = breakdownHTML;
        }

        async function viewReceiptByData(receipt) {
            const imageUrl = `https://drive.google.com/thumbnail?id=${receipt.driveFileId}&sz=w1000`;
            
            document.getElementById('modal-image').src = imageUrl;
            document.getElementById('modal-image').onerror = function() {
                this.src = `https://drive.google.com/uc?export=view&id=${receipt.driveFileId}`;
            };
            
            document.getElementById('modal-reg').textContent = `${receipt.carName} (${receipt.regNumber})`;
            
            const sellingDate = new Date(receipt.sellingDate).toLocaleDateString();
            let details = `Customer: ${receipt.customerName}<br>Phone: ${receipt.customerPhone}<br>`;
            details += `Date: ${sellingDate}<br>Price: ‚Ç®${parseFloat(receipt.sellingPrice).toLocaleString()}<br>`;
            details += `Purchase Cost: ‚Ç®${parseFloat(receipt.purchaseCost).toLocaleString()}<br>`;
            details += `Sold by: ${receipt.soldBy}<br>Payment: ${receipt.paymentType}`;
            
            document.getElementById('modal-details').innerHTML = details;

            const profit = calculateProfit(receipt);
            const modalProfit = document.getElementById('modal-profit');
            modalProfit.innerHTML = `
                <div class="commission-section">
                    <div style="color: #155724; font-weight: 600; margin-bottom: 8px;">üíµ Profit Summary</div>
                    <div style="color: #155724; font-size: 13px;">Profit: ‚Ç®${profit.netProfit.toLocaleString()} (${profit.profitMargin.toFixed(2)}%)</div>
                </div>
            `;
            
            const modalInsts = document.getElementById('modal-installments');
            if (receipt.paymentType === 'INSTALLMENT') {
                const receiptInsts = allInstallmentsCache.filter(i => i.receiptId === receipt.receiptId);
                
                let instsHTML = '<div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">';
                instsHTML += `<div style="color: white; font-weight: 700; margin-bottom: 10px;">Down Payment: ‚Ç®${parseFloat(receipt.downPayment).toLocaleString()}</div>`;
                instsHTML += '<div style="color: white; font-weight: 700; margin-bottom: 10px;">Installments:</div>';
                
                receiptInsts.forEach(inst => {
                    const isPaid = inst.status === 'PAID';
                    const statusColor = isPaid ? '#28a745' : '#ffc107';
                    const statusText = isPaid ? '‚úì Paid' : 'üìÖ Pending';
                    
                    instsHTML += `
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid ${statusColor};">
                            <div style="color: white;">Installment ${inst.installmentNumber}: ‚Ç®${parseFloat(inst.amount).toLocaleString()}</div>
                            <div style="color: white; font-size: 12px;">Due: ${new Date(inst.dueDate).toLocaleDateString()}</div>
                            <div style="color: ${statusColor}; font-weight: 700; font-size: 12px;">${statusText}</div>
                        </div>
                    `;
                });
                
                instsHTML += '</div>';
                modalInsts.innerHTML = instsHTML;
            } else {
                modalInsts.innerHTML = '';
            }
            
            document.getElementById('modal').classList.add('active');
            currentViewingReceipt = receipt;
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            currentViewingReceipt = null;
        }

        function openDriveLink() {
            if (currentViewingReceipt && currentViewingReceipt.driveLink) {
                window.open(currentViewingReceipt.driveLink, '_blank');
            }
        }

        async function deleteReceipt() {
            if (!currentViewingReceipt) return;
            
            if (confirm('Delete this receipt?')) {
                try {
                    const response = await fetch(CONFIG.GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'delete',
                            receiptId: currentViewingReceipt.receiptId,
                            driveFileId: currentViewingReceipt.driveFileId
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        closeModal();
                        loadAllReceipts();
                        alert('‚úì Receipt deleted');
                    } else {
                        throw new Error(result.error || 'Delete failed');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error deleting receipt');
                }
            }
        }

        async function calculateAnalytics() {
            if (allReceiptsCache.length === 0) {
                await loadAllReceipts();
            }

            const receipts = allReceiptsCache;
            const now = new Date();

            const totalCars = receipts.length;
            const totalRevenue = receipts.reduce((sum, r) => sum + (parseFloat(r.sellingPrice) || 0), 0);

            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const dayOfWeek = today.getDay();
            const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() + mondayOffset);
            
            const weekReceipts = receipts.filter(r => {
                const date = new Date(r.sellingDate);
                return date >= weekStart && date <= now;
            });
            const weekCars = weekReceipts.length;
            const weekRevenue = weekReceipts.reduce((sum, r) => sum + (parseFloat(r.sellingPrice) || 0), 0);

            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthReceipts = receipts.filter(r => {
                const date = new Date(r.sellingDate);
                return date >= monthStart && date <= now;
            });
            const monthCars = monthReceipts.length;
            const monthRevenue = monthReceipts.reduce((sum, r) => sum + (parseFloat(r.sellingPrice) || 0), 0);

            document.getElementById('total-cars').textContent = totalCars;
            document.getElementById('total-revenue').textContent = `‚Ç®${totalRevenue.toLocaleString()}`;
            document.getElementById('week-cars').textContent = weekCars;
            document.getElementById('week-revenue').textContent = `‚Ç®${weekRevenue.toLocaleString()}`;
            document.getElementById('month-cars').textContent = monthCars;
            document.getElementById('month-revenue').textContent = `‚Ç®${monthRevenue.toLocaleString()}`;

            calculateTopSalespeople();
            calculateBestSellingCars();
        }

        function calculateTopSalespeople() {
            const employeeStats = {};
            
            allReceiptsCache.forEach(r => {
                const emp = r.soldBy || 'Unknown';
                if (!employeeStats[emp]) {
                    employeeStats[emp] = { count: 0, revenue: 0 };
                }
                employeeStats[emp].count += 1;
                employeeStats[emp].revenue += parseFloat(r.sellingPrice) || 0;
            });
